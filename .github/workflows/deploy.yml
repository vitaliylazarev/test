name: FastAPI CI/CD Pipeline

on:
  workflow_dispatch:
    inputs:
      action:
        description: 'Select action to perform'
        required: true
        default: 'deploy'
        type: choice
        options:
          - build
          - deploy
          - cleanup

jobs:
  build:
    name: ğŸ—ï¸ Build Docker Image
    if: ${{ github.event.inputs.action == 'build' }}
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
      
    - name: Build Docker image
      uses: docker/build-push-action@v5
      with:
        context: .
        tags: my-fastapi-app:latest
        
    - name: Save build info
      run: |
        echo "âœ… Build completed successfully!"
        echo "ğŸ“¦ Image: my-fastapi-app:latest"

  deploy:
    name: ğŸš€ Deploy to Production
    runs-on: ubuntu-latest
    # Ğ£Ğ‘Ğ˜Ğ ĞĞ•Ğœ needs: build - Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ deploy Ğ¼Ğ¾Ğ³ Ğ·Ğ°Ğ¿ÑƒÑĞºĞ°Ñ‚ÑŒÑÑ Ğ½ĞµĞ·Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾
    if: ${{ github.event.inputs.action == 'deploy' }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Deploy to VPS
      uses: appleboy/ssh-action@v0.1.10
      with:
        host: ${{ secrets.VPS_HOST }}
        username: ${{ secrets.VPS_USERNAME }}
        key: ${{ secrets.VPS_SSH_KEY }}
        port: 22
        script: |
          echo "ğŸš€ Starting deployment..."
          mkdir -p ~/app
          cd ~/app
          
          if [ ! -d .git ]; then
            echo "ğŸ“¦ Cloning repository..."
            git clone https://github.com/${{ github.repository }}.git .
          else
            echo "ğŸ”„ Pulling latest changes..."
            git fetch origin
            git reset --hard origin/main
          fi
          
          echo "ğŸ³ Building and starting containers..."
          docker compose up -d --build
          
          echo "âœ… Deployment completed successfully!"
          echo "ğŸŒ Application available at: http://${{ secrets.VPS_HOST }}:8000"
          docker ps

  cleanup:
    name: ğŸ§¹ Cleanup Resources
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.action == 'cleanup' }}
    
    steps:
    - name: Cleanup on VPS
      uses: appleboy/ssh-action@v0.1.10
      with:
        host: ${{ secrets.VPS_HOST }}
        username: ${{ secrets.VPS_USERNAME }}
        key: ${{ secrets.VPS_SSH_KEY }}
        port: 22
        script: |
          echo "ğŸ§¹ Starting cleanup..."
          cd ~/app 2>/dev/null && docker compose down -v || echo "âš ï¸ No containers to remove"
          docker system prune -af
          echo "âœ… Cleanup completed!"

  status:
    name: ğŸ“Š Pipeline Status
    runs-on: ubuntu-latest
    needs: [build, deploy, cleanup]
    if: always()
    
    steps:
    - name: Show results
      run: |
        echo "ğŸ“‹ Pipeline Results:"
        echo "Build: ${{ needs.build.result || 'skipped' }}"
        echo "Deploy: ${{ needs.deploy.result || 'skipped' }}"
        echo "Cleanup: ${{ needs.cleanup.result || 'skipped' }}"
        echo "Workflow ID: ${{ github.run_id }}"