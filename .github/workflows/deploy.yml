name: FastAPI VPS Manager FIN

on:
  workflow_dispatch:
    inputs:
      action:
        description: 'Select action to perform'
        required: true
        default: 'deploy'
        type: choice
        options:
          - deploy
          - delete

jobs:
  deploy:
    name: ðŸš€ Deploy Application
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.action == 'deploy' }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Deploy to VPS
      uses: appleboy/ssh-action@v0.1.10
      with:
        host: ${{ secrets.VPS_HOST }}
        username: ${{ secrets.VPS_USERNAME }}
        key: ${{ secrets.VPS_SSH_KEY }}
        port: 22
        timeout: 300s
        script: |
          echo "ðŸš€ Starting deployment process..."
          mkdir -p ~/app
          cd ~/app
          
          # ÐšÐ»Ð¾Ð½Ð¸Ñ€ÑƒÐµÐ¼ Ð¸Ð»Ð¸ Ð¾Ð±Ð½Ð¾Ð²Ð»ÑÐµÐ¼ Ñ€ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ð¹
          if [ ! -d .git ]; then
            echo "ðŸ“¦ Cloning repository for the first time..."
            git clone https://github.com/${{ github.repository }}.git .
          else
            echo "ðŸ”„ Pulling latest changes..."
            git fetch origin
            git reset --hard origin/main
          fi
          
          echo "ðŸ³ Building and starting containers..."
          docker compose up -d --build
          
          echo "âœ… Deployment completed successfully!"
          echo "ðŸŒ Application available at: http://${{ secrets.VPS_HOST }}:8000"
          echo "ðŸ“Š Running containers:"
          docker ps

  delete:
    name: ðŸ—‘ï¸ Delete Containers
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.action == 'delete' }}
    
    steps:
    - name: Delete containers on VPS
      uses: appleboy/ssh-action@v0.1.10
      with:
        host: ${{ secrets.VPS_HOST }}
        username: ${{ secrets.VPS_USERNAME }}
        key: ${{ secrets.VPS_SSH_KEY }}
        port: 22
        script: |
          echo "ðŸ›‘ Stopping and removing containers..."
          cd ~/app 2>/dev/null && docker compose down -v || echo "âš ï¸ No containers to remove"
          
          echo "ðŸ§¹ Cleaning up Docker resources..."
          docker system prune -af --volumes 2>/dev/null || true
          
          echo "âœ… Cleanup completed!"
          echo "ðŸ“‹ All containers removed"